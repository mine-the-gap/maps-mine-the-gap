<!DOCTYPE html>
<html>
<head>
    <title>Global Material Areas Explorer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <script src="https://unpkg.com/geoblaze"></script>

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
        #map { height: 100vh; width: 100vw; background: #222; }
        #controls {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); width: 250px;
        }
        select { width: 100%; padding: 8px; margin-top: 10px; cursor: pointer; }
        .legend { font-size: 12px; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="controls">
    <div class="legend">SELECT MATERIAL LAYER</div>
    <select id="layer-select"></select>
    <div id="pixel-info" style="margin-top: 15px; font-size: 13px; max-height: 300px; overflow-y: auto;">
        Click map to query all layers
    </div>
</div>

<div id="map"></div>

<script>
    const cogUrl = "material_areas_km2.tif"; // Ensure this is in the same folder
    const NODATA = 65535;
    
    // Layer descriptions from your metadata
    const materialNames = ["Gold", "Coal", "Silver", "Copper", "Iron", "Zinc", "Molybdenum", "Lead", "Potash", "Lithium", "Nickel", "Cobalt", "Platinum_Group_Element", "Diamonds", "Phosphate", "Aluminium", "Magnetite", "Uranium", "Manganese", "Magnesium", "Rhodium", "Potassium", "Spodumene", "Zircon", "Tin", "Heavy_Mineral_Sands", "Titanium", "Rare_Earth_Element", "Rhenium", "Tungsten", "Chromite", "Antimony", "Niobium", "Vanadium", "Tantalum", "Calcine", "Kaolin", "Leucoxene", "Graphite", "Chromium", "Bismuth", "Ferrochrome", "Rubidium", "Mercury", "Cadmium", "Selenium", "Tellurium", "Arsenic", "Ferronickel", "Sulphuric_Acid", "Gallium", "Strontium", "Germanium", "Indium", "Limestone", "Calcium_Carbonate", "Barite", "Ammonium_Sulfate", "Coke", "Crude_Oil", "Tar", "Sodium_Tripolyphosphate", "Asbestos", "Ferroniobium", "Beryllium", "Garnet", "Ferrovanadium", "Caesium", "Ferrotungsten", "Aggregates", "Hematite", "Dolomite", "Nepheline", "Silica", "Sulfur", "Marble", "Borates", "Rutile", "Vermiculite", "Pyrite", "Gypsum", "Frac_Sand", "Emerald", "Beryl", "Sapphire", "Fluorspar"];

    // Initialize Map
    const map = L.map('map').setView([20, 0], 2);

    const baseMaps = {
        "Map": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map),
        "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' })
    };
    L.control.layers(baseMaps).addto(map);

    let geoRasterLayer;
    let currentRaster;

    // Populate Dropdown
    const select = document.getElementById('layer-select');
    materialNames.forEach((name, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerHTML = name.replace(/_/g, ' ');
        select.appendChild(opt);
    });

    // Load COG
    parseGeoraster(cogUrl).then(georaster => {
        currentRaster = georaster;
        updateLayer(0); // Start with Gold (Band 1)

        // Dropdown interaction
        select.onchange = (e) => updateLayer(parseInt(e.target.value));

        // Click interaction
        map.on('click', e => {
            const results = geoblaze.identify(georaster, [e.latlng.lng, e.latlng.lat]);
            let html = `<strong>Location:</strong> ${e.latlng.lat.toFixed(2)}, ${e.latlng.lng.toFixed(2)}<br><hr>`;
            
            if (results) {
                results.forEach((val, i) => {
                    if (val !== NODATA && val !== null) {
                        const area = (val / 10).toFixed(1);
                        html += `<div><strong>${materialNames[i].replace(/_/g, ' ')}:</strong> ${area} kmÂ²</div>`;
                    }
                });
            } else {
                html += "No data at this location.";
            }
            document.getElementById('pixel-info').innerHTML = html;
        });
    });

    function updateLayer(bandIndex) {
        if (geoRasterLayer) map.removeLayer(geoRasterLayer);

        geoRasterLayer = new GeoRasterLayer({
            georaster: currentRaster,
            opacity: 0.8,
            pixelValuesToColorFn: values => {
                const val = values[bandIndex];
                if (val === NODATA || val === 0) return null;
                // Simple Ramp: Higher density = deeper purple/red
                return val > 1000 ? '#800026' : val > 500 ? '#E31A1C' : '#FEB24C';
            },
            resolution: 256
        });
        geoRasterLayer.addTo(map);
    }
</script>

</body>
</html>
